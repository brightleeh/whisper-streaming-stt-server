name: CI

# Trigger on push or pull request to main/master branches
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/${{ github.repository }}-test:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user 1001

    steps:
      - uses: actions/checkout@v4

      # 1. Generate Protobuf/gRPC Stubs
      # Without this step, import errors will occur due to missing generated code.
      - name: Generate gRPC Stubs
        run: |
          mkdir -p gen/stt/python/v1
          touch gen/__init__.py
          touch gen/stt/__init__.py
          touch gen/stt/python/__init__.py
          touch gen/stt/python/v1/__init__.py

          # Execute command as specified in README.md
          python3 -m grpc_tools.protoc \
            -I proto \
            --python_out=gen/stt/python/v1 \
            --grpc_python_out=gen/stt/python/v1 \
            --mypy_out=./gen/stt/python/v1 \
            proto/stt.proto

      # 2. Run Tests
      # Set PYTHONPATH to current directory (.) to locate stt_server and gen packages.
      - name: Run Unit Tests
        env:
          PYTHONPATH: .
          STT_SKIP_INTEGRATION: 1
        run: |
          ./tools/run_tests.sh unit

      - name: Run Abuse Tests
        env:
          PYTHONPATH: .
        run: |
          ./tools/run_tests.sh abuse

      - name: Run Integration Tests
        env:
          PYTHONPATH: .
          STT_REQUIRE_EXISTING: 0
        run: |
          ./tools/run_tests.sh integration
