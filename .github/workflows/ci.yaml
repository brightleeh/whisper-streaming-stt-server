name: CI

# Trigger on push or pull request to main/master branches
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test:
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/${{ github.repository }}-test:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user 1001

    steps:
      - uses: actions/checkout@v4

      - name: Generate gRPC Stubs
        run: ./tools/gen_proto.sh

      # 2. Run Tests
      # Set PYTHONPATH to current directory (.) to locate stt_server and gen packages.
      - name: Run Unit Tests
        env:
          PYTHONPATH: .
          STT_SKIP_INTEGRATION: 1
        run: |
          ./tools/run_tests.sh unit

      - name: Run Abuse Tests
        env:
          PYTHONPATH: .
        run: |
          ./tools/run_tests.sh abuse

      - name: Run Integration Tests
        env:
          PYTHONPATH: .
          STT_REQUIRE_EXISTING: 0
        run: |
          ./tools/run_tests.sh integration
