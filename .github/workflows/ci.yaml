name: CI

# Trigger on push or pull request to main/master branches
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"] # Recommended 3.10 as Dockerfile is based on Ubuntu 22.04

    steps:
      - uses: actions/checkout@v4

      # 1. Install System Dependencies (Reference: Dockerfile)
      # ffmpeg, pkg-config, etc. are required for faster-whisper/PyAV.
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 pkg-config libavformat-dev libavcodec-dev libavdevice-dev

      # 2. Set up Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip" # Cache pip packages for speed

      # 3. Install Python Dependencies
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-asyncio requests mypy-protobuf  # Add packages for testing and stub generation

      # 4. Generate Protobuf/gRPC Stubs (Critical!)
      # Without this step, import errors will occur due to missing generated code.
      - name: Generate gRPC Stubs
        run: |
          mkdir -p gen/stt/python/v1
          touch gen/__init__.py
          touch gen/stt/__init__.py
          touch gen/stt/python/__init__.py
          touch gen/stt/python/v1/__init__.py

          # Execute command as specified in README.md
          python -m grpc_tools.protoc \
            -I proto \
            --python_out=gen/stt/python/v1 \
            --grpc_python_out=gen/stt/python/v1 \
            --mypy_out=./gen/stt/python/v1 \
            proto/stt.proto

      # 5. Run Tests
      # Set PYTHONPATH to current directory (.) to locate stt_server and gen packages.
      - name: Run Tests
        env:
          PYTHONPATH: .
        run: |
          pytest
