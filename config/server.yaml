server:
  port: 50051 # gRPC listen port
  http_host: "0.0.0.0" # HTTP metrics/health bind host
  ws_host: "0.0.0.0" # WebSocket streaming bind host
  max_sessions: 50 # Concurrent gRPC sessions
  metrics_port: 8000 # HTTP metrics/health port
  ws_port: 8001 # WebSocket streaming port
  grpc_worker_threads: 0 # gRPC thread pool size (0 = auto; keep >max_sessions to avoid starving short RPCs)
  create_session_rps: 400.0 # CreateSession requests/sec (0 disables)
  create_session_burst: 800.0 # CreateSession burst tokens (0 uses rps)
  max_sessions_per_ip: 100 # Concurrent sessions per client IP (0 disables)
  max_sessions_per_api_key: 100 # Concurrent sessions per api_key (0 disables)
  max_audio_seconds_per_session: 3600.0 # Hard cap on total audio seconds per session (0 disables)
  max_audio_bytes_per_sec: 3200000 # Inbound audio byte rate limit per key (0 disables)
  max_audio_bytes_per_sec_burst: 6400000 # Burst allowance for audio byte rate limit (0 uses bytes/sec)
  # Optional per-session-mode overrides (set upload_mode=batch on CreateSession).
  # When unset, the base max_audio_bytes_per_sec values above are used.
  max_audio_bytes_per_sec_realtime: null
  max_audio_bytes_per_sec_burst_realtime: null
  max_audio_bytes_per_sec_batch: 0
  max_audio_bytes_per_sec_burst_batch: 0
  http_rate_limit_rps: 5.0 # HTTP requests/sec (0 disables)
  http_rate_limit_burst: 10.0 # HTTP burst tokens (0 uses rps)
  http_trusted_proxies: [] # Trusted proxy CIDR/hostnames for X-Forwarded-For
  decode_timeout_sec: 30 # Seconds to wait for decode tasks when draining
  log_metrics: false # Emit decode metrics logs
  session_timeout_sec: 60 # Seconds of inactivity before aborting a session
  max_buffer_sec: 20 # Max buffered audio seconds before partial decode/trim (null disables)
  max_buffer_bytes: null # Max buffered audio bytes before partial decode/trim (null disables)
  max_chunk_ms: 2000 # Max single chunk duration in milliseconds (null disables)
  partial_decode_interval_sec: 1.5 # Partial decode interval during speech (null disables)
  partial_decode_window_sec: 10.0 # Window size for partial decode audio (seconds)
  emit_final_on_vad: false # Emit final result when VAD triggers without ending stream
  # Adaptive throttling (optional; defaults off).
  adaptive_throttle_enabled: false
  adaptive_throttle_interval_sec: 2.0
  adaptive_pending_ratio_high: 0.8
  adaptive_buffer_ratio_high: 0.85
  adaptive_orphan_rate_high: 0.2
  adaptive_partial_interval_scale: 2.0
  adaptive_partial_interval_max_sec: null
  adaptive_batch_window_target_ms: 0
  adaptive_create_session_backoff_sec: 2.0
  max_pending_decodes_per_stream: 8 # Max queued decodes per stream before dropping partials
  max_pending_decodes_global: 1024 # Global max queued decodes before backpressure/drop
  max_total_buffer_bytes: 536870912 # Global buffered audio cap (bytes)
  decode_queue_timeout_sec: 1.0 # Seconds to wait for a global decode slot (final only)
  decode_batch_window_ms: 0 # Batch window for shared decode queue (0 disables)
  max_decode_batch_size: 1 # Max tasks per batch (1 disables)
  buffer_overlap_sec: 0.5 # Overlap window retained after partial decode (seconds)
  grpc_max_receive_message_bytes: 8388608 # Max gRPC inbound message size
  grpc_max_send_message_bytes: 4194304 # Max gRPC outbound message size
  sample_rate: 16000 # Fallback sample rate when chunks omit it

vad:
  silence: 0.5 # Seconds of trailing silence to trigger decode
  threshold: 0.5 # Silero VAD speech probability threshold (0-1)
  model_pool_size: 16 # VAD model pool size (keep modest to save memory)
  model_prewarm: 4 # Prewarm VAD models on startup
  model_pool_growth_factor: 1.5 # VAD pool growth factor on demand

safety:
  speech_rms_threshold: 0.00 # Minimum RMS required before decoding buffered audio

logging:
  level: "INFO" # TRACE/DEBUG/INFO/WARN/ERROR
  file: null # Optional log file path
  faster_whisper_level: null # Optional: override faster_whisper logger level
  log_transcripts: false # Log transcript text in decode logs (PII risk)
  transcript_file: null # Optional transcript sink; required for PII logging
  transcript_retention_days: 7 # Retain transcript logs for N days

tls:
  cert_file: null # Path to TLS cert chain (enables gRPC TLS)
  key_file: null # Path to TLS private key (enables gRPC TLS)
  required: false # Require TLS; refuse to start without cert/key

metrics:
  expose_api_key_sessions: false # Include active_sessions_by_api in /metrics payload

auth:
  require_api_key: false # Require api_key attribute on CreateSession
  create_session_auth_profile: "none" # none|api_key|signed_token
  create_session_auth_secret: "" # HMAC secret for signed_token profile
  create_session_auth_ttl_sec: 0.0 # Auth token TTL seconds (0 disables)
  # signed_token expects gRPC metadata: authorization (Bearer <sig> or <ts>:<sig>) and x-stt-auth-ts

storage:
  persist_audio: false # Enable server-side audio capture
  directory: "data/audio" # Directory to store captured audio
  queue_max_chunks: 256 # Max queued PCM chunks before dropping oldest
  max_bytes: null # Optional cap on total bytes in directory
  max_files: null # Optional maximum number of stored files
  max_age_days: null # Optional retention window in days

health:
  window_sec: 60 # Rolling window for decode health aggregation
  min_events: 5 # Minimum events before evaluating health ratios
  max_timeout_ratio: 0.5 # Degraded when decode timeouts exceed this ratio
  min_success_ratio: 0.5 # Degraded when successful decodes fall below this ratio
